<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.tigetting.mapper.PaymentMapper">

    <insert id="save" useGeneratedKeys="true" keyProperty="paymentId">
        INSERT INTO payments (booking_id, transaction_id, amount, payment_method, status, pg_response, paid_at, created_at, updated_at)
        VALUES (#{booking.bookingId}, #{transactionId}, #{amount}, #{paymentMethod}, #{status}, #{pgResponse}, #{paidAt}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="update">
        UPDATE payments
        SET status = #{status},
            pg_response = #{pgResponse},
            paid_at = #{paidAt},
            updated_at = #{updatedAt}
        WHERE payment_id = #{paymentId}
    </update>

    <select id="findById" resultMap="PaymentResultMap">
        SELECT * FROM payments WHERE payment_id = #{id}
    </select>

    <select id="findByTransactionId" resultMap="PaymentResultMap">
        SELECT * FROM payments WHERE transaction_id = #{transactionId}
    </select>

    <select id="findByBookingId" resultMap="PaymentResultMap">
        SELECT * FROM payments WHERE booking_id = #{bookingId}
    </select>

    <resultMap id="PaymentResultMap" type="Payment">
        <id property="paymentId" column="payment_id"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="amount" column="amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="status" column="status"/>
        <result property="pgResponse" column="pg_response"/>
        <result property="paidAt" column="paid_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="booking" column="booking_id" select="com.ssafy.tigetting.mapper.BookingMapper.findById"/>
    </resultMap>

</mapper>
