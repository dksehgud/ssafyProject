<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.tigetting.mapper.PerformanceMapper">

    <insert id="save" useGeneratedKeys="true" keyProperty="performanceId">
        INSERT INTO performances (venue_id, title, description, theme, poster_url, start_date, end_date, running_time, base_price, status, created_at, updated_at)
        VALUES (#{venue.venueId}, #{title}, #{description}, #{theme}, #{posterUrl}, #{startDate}, #{endDate}, #{runningTime}, #{basePrice}, #{status}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="update">
        UPDATE performances
        SET venue_id = #{venue.venueId},
            title = #{title},
            description = #{description},
            theme = #{theme},
            poster_url = #{posterUrl},
            start_date = #{startDate},
            end_date = #{endDate},
            running_time = #{runningTime},
            base_price = #{basePrice},
            status = #{status},
            updated_at = #{updatedAt}
        WHERE performance_id = #{performanceId}
    </update>

    <select id="findAll" resultType="com.ssafy.tigetting.performance.dto.PerformanceDto">
        SELECT 
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        ORDER BY p.prfpdfrom DESC
        LIMIT 100
    </select>

    <select id="findById" resultType="com.ssafy.tigetting.performance.dto.PerformanceDto">
        SELECT 
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        WHERE p.mt20id = #{id}
    </select>

    <resultMap id="PerformanceDetailResultMap" type="com.ssafy.tigetting.performance.dto.PerformanceDetailDto">
        <result property="mt20id" column="mt20id"/>
        <result property="prfnm" column="prfnm"/>
        <result property="prfpdfrom" column="prfpdfrom"/>
        <result property="prfpdto" column="prfpdto"/>
        <result property="fcltynm" column="fcltynm"/>
        <result property="poster" column="poster"/>
        <result property="area" column="area"/>
        <result property="genreName" column="genreName"/>
        <result property="prfstate" column="prfstate"/>
        <result property="mt10id" column="mt10id"/>
        <result property="prfcast" column="prfcast"/>
        <result property="prfcrew" column="prfcrew"/>
        <result property="prfruntime" column="prfruntime"/>
        <result property="prfage" column="prfage"/>
        <result property="pcseguidance" column="pcseguidance"/>
        <result property="sty" column="sty"/>
        <result property="updatedate" column="updatedate"/>
        <result property="dtguidance" column="dtguidance"/>
        <collection property="styurls" ofType="String">
            <result column="styurl"/>
        </collection>
    </resultMap>

    <select id="findDetailById" resultMap="PerformanceDetailResultMap">
        SELECT 
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id,
            pd.prfcast,
            pd.prfcrew,
            pd.prfruntime,
            pd.prfage,
            pd.pcseguidance,
            pd.sty,
            pd.updatedate,
            pd.dtguidance,
            ps.styurl
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        LEFT JOIN performance_details pd ON p.mt20id = pd.mt20id
        LEFT JOIN performance_styurls ps ON p.mt20id = ps.mt20id
        WHERE p.mt20id = #{id}
    </select>

    <select id="findByVenueId" resultMap="PerformanceResultMap">
        SELECT * FROM performances WHERE venue_id = #{venueId}
    </select>

    <delete id="deleteById">
        DELETE FROM performances WHERE performance_id = #{id}
    </delete>

    <select id="findByVenueIdAndFilters" resultType="com.ssafy.tigetting.performance.dto.PerformanceDto">
        SELECT
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        <where>
            <if test="mt10id != null">
                p.mt10id = #{mt10id}
            </if>
            <if test="genreId != null">
                AND p.genreid = #{genreId}
            </if>
        </where>
        ORDER BY p.prfpdfrom DESC
        LIMIT 100
    </select>

    <resultMap id="PerformanceResultMap" type="Performance">
        <id property="performanceId" column="performance_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="theme" column="theme"/>
        <result property="posterUrl" column="poster_url"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="runningTime" column="running_time"/>
        <result property="basePrice" column="base_price"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="venue" column="venue_id" select="com.ssafy.tigetting.venue.mapper.VenueMapper.findById"/>
    </resultMap>

    <!-- ========== AI 추천 시스템 추가 쿼리 ========== -->
    
    <!-- 전체 활성 공연 조회 (AI 배치용) -->
    <select id="selectAllActivePerformances" resultType="com.ssafy.tigetting.recommendation.dto.PerformanceForAI">
        SELECT 
            p.mt20id,
            p.prfnm,
            p.genreid,
            p.prfstate,
            p.prfpdfrom,
            p.prfpdto,
            p.area,
            p.fcltynm,
            pd.prfcast
        FROM performances p
        LEFT JOIN performance_details pd ON p.mt20id = pd.mt20id
        WHERE p.prfstate IN ('공연중', '공연예정')
          AND p.prfpdto >= CURDATE()
        ORDER BY p.prfpdfrom DESC
    </select>
    
    <!-- ID 목록으로 공연 상세 조회 (순서 유지) -->
    <select id="selectByIds" resultType="com.ssafy.tigetting.performance.dto.PerformanceDto">
        SELECT 
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        WHERE p.mt20id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY FIELD(p.mt20id, 
        <foreach collection="ids" item="id" separator=",">
            #{id}
        </foreach>
        )
    </select>

</mapper>
