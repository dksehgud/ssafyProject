<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.tigetting.reservation.mapper.ReservationMapper">

    <!-- ResultMap -->
    <resultMap id="reservationMap" type="ReservationEntity">
        <id property="reservationId" column="reservation_id"/>
        <result property="reservationGroupId" column="reservation_group_id"/>
        <result property="userId" column="userid"/>
        <result property="mt20id" column="mt20id"/>
        <result property="performanceSeatId" column="performance_seat_id"/>
        <result property="price" column="price"/>
        <result property="status" column="status"/>
        <result property="reservedAt" column="reserved_at"/>
    </resultMap>

    <!-- 예약 생성 -->
    <insert id="insertReservation" useGeneratedKeys="true" keyProperty="reservationId">
        INSERT INTO reservations (
            reservation_group_id,
            userid,
            mt20id,
            performance_seat_id,
            price,
            status,
            reserved_at
        ) VALUES (
            #{reservationGroupId},
            #{userId},
            #{mt20id},
            #{performanceSeatId},
            #{price},
            #{status},
            NOW()
        )
    </insert>

    <!-- 예약 그룹 조회 -->
    <select id="findByReservationGroupId" resultMap="reservationMap">
        SELECT *
        FROM reservations
        WHERE reservation_group_id = #{groupId}
        ORDER BY reservation_id
    </select>

    <!-- 회원 예약 목록 -->
    <select id="findByUserId" resultMap="reservationMap">
        SELECT *
        FROM reservations
        WHERE userid = #{userId}
        ORDER BY reserved_at DESC
    </select>

    <!-- 예약 상태 변경 (전체 취소) -->
    <update id="updateStatusByGroupId">
        UPDATE reservations
        SET status = #{status}
        WHERE reservation_group_id = #{groupId}
    </update>

</mapper>
