<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.tigetting.mapper.AdminPerformanceMapper">

    <!-- 예정된 공연 조회 (공연 시작일 기준 최신순) -->
    <select id="getUpcomingPerformances" resultType="com.ssafy.tigetting.performance.dto.PerformanceDto">
        SELECT
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        WHERE p.prfpdfrom >= CURDATE()
        ORDER BY p.prfpdfrom DESC
        LIMIT #{limit}
    </select>

    <!-- 공연 목록 조회 (페이징, 검색, 필터링) -->
    <select id="getPerformanceList" resultType="com.ssafy.tigetting.performance.dto.PerformanceDto">
        SELECT
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            g.genrenm as genreName,
            p.prfstate,
            p.mt10id,
            p.genreid
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        <where>
            <if test="search != null and search != ''">
                AND p.prfnm LIKE CONCAT('%', #{search}, '%')
            </if>
            <if test="genreId != null">
                AND p.genreid = #{genreId}
            </if>
            <if test="area != null and area != ''">
                AND p.area = #{area}
            </if>
            <if test="prfstate != null and prfstate != ''">
                AND p.prfstate = #{prfstate}
            </if>
        </where>
        ORDER BY p.prfpdfrom DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 공연 총 개수 (필터링 적용) -->
    <select id="getPerformanceCount" resultType="int">
        SELECT COUNT(*)
        FROM performances p
        <where>
            <if test="search != null and search != ''">
                AND p.prfnm LIKE CONCAT('%', #{search}, '%')
            </if>
            <if test="genreId != null">
                AND p.genreid = #{genreId}
            </if>
            <if test="area != null and area != ''">
                AND p.area = #{area}
            </if>
            <if test="prfstate != null and prfstate != ''">
                AND p.prfstate = #{prfstate}
            </if>
        </where>
    </select>

    <!-- 공연 ID로 기본 정보 조회 -->
    <select id="getPerformanceById" resultType="map">
        SELECT
            p.mt20id,
            p.prfnm,
            p.prfpdfrom,
            p.prfpdto,
            p.fcltynm,
            p.poster,
            p.area,
            p.genreid,
            p.prfstate,
            p.mt10id,
            g.genrenm as genreName
        FROM performances p
        LEFT JOIN genres g ON p.genreid = g.genreid
        WHERE p.mt20id = #{mt20id}
    </select>

    <!-- 공연 상세 정보 조회 -->
    <select id="getPerformanceDetails" resultType="map">
        SELECT
            prfcast,
            prfcrew,
            prfruntime,
            prfage,
            pcseguidance,
            sty,
            dtguidance
        FROM performance_details
        WHERE mt20id = #{mt20id}
    </select>

    <!-- 공연 스틸이미지 URL 조회 -->
    <select id="getPerformanceStyurls" resultType="string">
        SELECT styurl
        FROM performance_styurls
        WHERE mt20id = #{mt20id}
    </select>
    
    <!-- 공연 정보 수정 -->
    <update id="updatePerformance">
        UPDATE performances
        <set>
            <if test="data.prfnm != null">prfnm = #{data.prfnm},</if>
            <if test="data.prfpdfrom != null">prfpdfrom = #{data.prfpdfrom},</if>
            <if test="data.prfpdto != null">prfpdto = #{data.prfpdto},</if>
            <if test="data.fcltynm != null">fcltynm = #{data.fcltynm},</if>
            <if test="data.poster != null">poster = #{data.poster},</if>
            <if test="data.area != null">area = #{data.area},</if>
            <if test="data.genreid != null">genreid = #{data.genreid},</if>
            <if test="data.prfstate != null">prfstate = #{data.prfstate},</if>
            <if test="data.mt10id != null">mt10id = #{data.mt10id},</if>
        </set>
        WHERE mt20id = #{mt20id}
    </update>
    
    <!-- 공연 삭제 -->
    <delete id="deletePerformance">
        DELETE FROM performances
        WHERE mt20id = #{mt20id}
    </delete>

</mapper>
